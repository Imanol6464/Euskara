
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Euskara ¬∑ Ikasi ‚Äî v8 (10 le√ßons compl√®tes)</title>
  <meta name="theme-color" content="#ffffff">
  <style>
/* ================= LIGHT THEME, BASQUE ACCENTS ================= */
:root{
  --bg:#f9fafb;
  --surface:#ffffff;
  --surface-2:#f3f4f6;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
  --green:#007A3D;   /* Basque green */
  --green2:#0a6f3a;
  --red:#D90429;     /* Basque red */
  --blue:#2563eb;
  --ok:#16a34a;
  --warn:#ef4444;
  --shadow: 0 8px 24px rgba(17,24,39,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
a{color:var(--blue);text-decoration:none}
header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.9);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid var(--border)}
.container{max-width:1100px;margin:0 auto;padding:12px 16px}
.brand{display:flex;align-items:center;gap:12px}
.logo{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--red),var(--green));color:white;font-weight:900}
.title h1{margin:0;font-size:20px;letter-spacing:.2px}
.title small{color:var(--muted)}
main{max-width:1100px;margin:18px auto 64px auto;padding:0 16px}
.grid{display:grid;gap:16px;grid-template-columns: 1fr}
@media (min-width: 920px){ .grid{grid-template-columns: 380px 1fr} }
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.badge{display:inline-flex;align-items:center;gap:6px;font-weight:700;background:#e8f5eb;border:1px solid #c1e5cd;color:var(--green);padding:4px 10px;border-radius:999px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.btn{appearance:none;border:none;cursor:pointer;font-weight:700;border-radius:12px;padding:14px 16px;background:#ffffff;border:2px solid var(--border);color:#1f2937;min-height:48px;transition:transform .05s ease, box-shadow .15s ease}
.btn:active{transform:translateY(1px)}
.btn.primary{background:linear-gradient(180deg,#b7f0c8,#7ae582);border:none;color:#063d1a}
.btn.green{background:linear-gradient(180deg,#84fab0,#3bd47a);border:none;color:#05351f}
.btn.red{background:linear-gradient(180deg,#ffb3b3,var(--red));border:none;color:#5b0b0b}
.btn.ghost{background:#ffffff;border:2px solid var(--border)}
.progress{height:12px;background:#e5e7eb;border:1px solid #e5e7eb;border-radius:999px;overflow:hidden;margin-top:10px}
.progress > div{height:100%;background:linear-gradient(90deg,#8ce9af,var(--green));width:0%}
.lesson-list{display:grid;gap:8px}
.lesson-item{display:flex;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--border);border-radius:12px;background:var(--surface)}
.lesson-item .meta{display:flex;gap:10px;align-items:center}
.tag{font-size:12px;padding:4px 8px;border:1px solid #cdebd7;border-radius:999px;color:var(--green);background:#e8f5eb}
.kv{display:grid;grid-template-columns: 1fr auto;align-items:center;gap:8px;padding:10px;border-radius:12px;border:1px solid var(--border);background:var(--surface-2)}
.kv .eu{font-weight:800}
.kv small{color:var(--muted)}
.kv .speak{background:transparent;border:none;font-size:18px;cursor:pointer;color:var(--green)}
hr{border:none;border-top:1px solid var(--border);margin:8px 0}
.q{display:grid;gap:12px}
.q .topline{display:flex;justify-content:space-between;align-items:center}
.q .counter{font-weight:800}
.q .prompt{font-weight:800;font-size:18px;margin-top:6px}
.options{display:grid;gap:10px}
.option{padding:14px;text-align:left;border:2px solid var(--border);border-radius:12px;background:#ffffff;color:var(--text);cursor:pointer;min-height:48px}
.option.correct{border-color: var(--green); background: #f0fff4}
.option.wrong{border-color: var(--red); background: #fff5f5}
.wordbank{display:flex;flex-wrap:wrap;gap:8px}
.tile{padding:10px 12px;border-radius:12px;border:2px solid var(--border);background:#ffffff;cursor:pointer}
.tile.used{opacity:.6}
.answer-strip{display:flex;flex-wrap:wrap;gap:8px;min-height:44px;padding:8px;border:2px dashed #d1d5db;border-radius:12px;background:#f8fafc}
.answer-token{padding:10px 12px;border-radius:12px;border:2px solid var(--border);background:#e7f6ee}
footer{max-width:1100px;margin:30px auto;padding:0 16px;color:var(--muted);text-align:center}
.hide{display:none !important}

/* IMMERSIVE MODE (full-screen lesson) */
body.immersive header{position:static; border-bottom:none}
body.immersive .grid{grid-template-columns: 1fr}
body.immersive #picker{display:none}
body.immersive #intro{display:none}
body.immersive #quiz-area{min-height: calc(100vh - 120px)}

/* POPUP feedback */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal{max-width:560px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.2);padding:20px;border:3px solid var(--border);text-align:center}
.modal h2{margin:0 0 8px 0;font-size:28px}
.modal.ok{border-color: var(--green)}
.modal.no{border-color: var(--red)}
.modal .explain{color:#374151;margin-top:8px;text-align:left}
.modal .wordbyword{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:8px;text-align:left}
.modal .actions{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* INTRO panel */
#intro{display:none}
.intro-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
.intro-grid{display:grid;gap:10px}
.intro-grid .kv{background:#fff}

/* Better mobile layout */
@media (max-width: 919px){
  .btn, .option{width:100%}
  .lesson-item{padding:12px}
}
  </style>
</head>
<body>
  <header>
    <div class="container brand">
      <div class="logo">EU</div>
      <div class="title">
        <h1>Euskara ¬∑ Ikasi</h1>
        <small>10 le√ßons ‚Ä¢ Basque batua ‚Ä¢ mode immersif</small>
      </div>
    </div>
  </header>

  <main class="container grid">
    <!-- LEFT: Lesson picker + vocab -->
    <div class="card" id="picker">
      <div class="section-title">
        <span class="badge">Parcours D√©butant</span>
        <h3>Choisis une le√ßon</h3>
      </div>
      <div class="lesson-list" id="lesson-list"></div>
      <hr />
      <div>
        <h3>Aper√ßu vocabulaire (le√ßon s√©lectionn√©e)</h3>
        <div class="intro-grid" id="vocab-preview"></div>
        <div class="controls">
          <button class="btn" id="tts-all">üîä Tout √©couter</button>
          <button class="btn green" id="start">D√©marrer la le√ßon</button>
        </div>
        <div class="progress" aria-label="Progression le√ßon"><div id="progress"></div></div>
      </div>
    </div>

    <!-- RIGHT: Intro + Quiz -->
    <div id="intro">
      <div class="intro-card">
        <span class="badge" id="lesson-badge">Le√ßon</span>
        <h2 id="intro-title">‚Äî</h2>
        <p id="intro-text" style="margin:6px 0 12px 0;color:var(--muted)"></p>
        <h3>Vocabulaire cl√©</h3>
        <div class="intro-grid" id="intro-vocab"></div>
        <h3 style="margin-top:14px">Constructions / grammaire</h3>
        <div id="intro-grammar" class="intro-grid"></div>
        <div class="controls">
          <button class="btn green" id="intro-go">Commencer ‚ñ∂</button>
        </div>
      </div>
    </div>

    <div class="card" id="quiz-area">
      <div class="q">
        <div class="topline">
          <div>
            <span class="badge" id="live-lesson">Le√ßon</span>
            <strong id="lesson-title">‚Äî</strong>
          </div>
          <div class="counter" id="counter">0/30</div>
        </div>
        <div class="prompt" id="q-prompt"></div>

        <div class="options" id="q-options"></div>
        <!-- WORD BANK MODE -->
        <div id="bank-wrap" class="hide">
          <div class="answer-strip" id="answer-strip" aria-label="R√©ponse"></div>
          <div class="wordbank" id="wordbank"></div>
          <div class="controls">
            <button class="btn ghost" id="bank-undo">Effacer le dernier</button>
            <button class="btn red" id="bank-clear">Tout effacer</button>
          </div>
        </div>

        <div class="controls">
          <button class="btn red" id="idk">Je ne sais pas</button>
          <button class="btn green" id="next" disabled>Suivant ‚ñ∂</button>
          <button class="btn green hide" id="finish">Terminer la le√ßon</button>
        </div>
      </div>
    </div>
  </main>

  <div id="overlay">
    <div class="modal" id="modal">
      <h2 id="modal-title">‚Äî</h2>
      <div id="modal-msg"></div>
      <div class="explain" id="modal-explain"></div>
      <div class="wordbyword" id="modal-wbw"></div>
      <div class="actions">
        <button class="btn green" id="modal-continue">Continuer</button>
      </div>
    </div>
  </div>

  <footer>v8 ‚Ä¢ UI claire ‚Ä¢ pop‚Äëup p√©dagogiques ‚Ä¢ banques de mots ‚Ä¢ progression n/30 ‚Ä¢ erreurs repos√©es jusqu‚Äô√† r√©ussite.</footer>

  <script>
/* =================== DATA (BASQUE BATUA) =================== */
/* Chaque le√ßon a: id,title,tag,intro,vocab[],grammar[], baseQuestions[] */
/* On g√©n√®re ensuite ~30 items / le√ßon (mix MCQ & WordBank) */
const LESSONS_BASE = [
  {
    id:"l1",
    title:"Agurrak ¬∑ Salutations",
    tag:"Bases",
    intro:"Saluer et prendre cong√©. Formules en basque batua: Kaixo, Egun on, Arratsalde on, Gabon, Agur.",
    vocab:[
      {eu:"Kaixo", fr:"Bonjour / Salut"},
      {eu:"Egun on", fr:"Bonjour (matin)"},
      {eu:"Arratsalde on", fr:"Bon apr√®s-midi"},
      {eu:"Gabon", fr:"Bonsoir / Bonne nuit"},
      {eu:"Agur", fr:"Au revoir"}
    ],
    grammar:[
      "Saluer le matin: ¬´Egun on¬ª.",
      "Formule g√©n√©rale: ¬´Kaixo¬ª.",
      "Le soir/nuit: ¬´Gabon¬ª.",
      "Prendre cong√©: ¬´Agur¬ª.",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ Bonjour (matin) ¬ª en euskara batua ?", options:["Egun on","Kaixo","Gabon","Arratsalde on"], answer:"Egun on", explain:"¬´Egun on¬ª s‚Äôemploie le matin."},
      {type:"mcq", prompt:"¬´ Agur ¬ª signifie‚Ä¶", options:["Merci","Au revoir","S'il te pla√Æt","√Ä demain"], answer:"Au revoir", explain:"Formule standard pour dire au revoir."},
      {type:"mcq", prompt:"¬´ Gabon ¬ª = ", options:["Bonsoir/Bonne nuit","Bonjour","Bon apr√®s-midi","Salut"], answer:"Bonsoir/Bonne nuit", explain:"Employ√© le soir et la nuit."},
      {type:"bank", prompt:"Compose ¬´ Bon apr√®s‚Äëmidi ¬ª", acceptable:["arratsalde on","arratsaldeon"], bank:["arratsalde","on","kaixo","egun","gabon"], explain:"Les deux orthographes existent."},
    ]
  },
  {
    id:"l2",
    title:"Adeitasuna ¬∑ Politesse",
    tag:"Bases",
    intro:"Dire merci/s‚Äôil vous pla√Æt, s‚Äôexcuser, demander de l‚Äôaide, g√©rer l‚Äôincompr√©hension.",
    vocab:[
      {eu:"Eskerrik asko", fr:"Merci beaucoup"},
      {eu:"Mesedez", fr:"S'il vous pla√Æt"},
      {eu:"Barkatu", fr:"Pardon / Excusez‚Äëmoi"},
      {eu:"Ez dut ulertzen", fr:"Je ne comprends pas"},
      {eu:"Lagundu nazakezu?", fr:"Pouvez‚Äëvous m'aider ?"}
    ],
    grammar:[
      "¬´Eskerrik asko¬ª = merci (beaucoup).",
      "¬´Mesedez¬ª pour une demande polie.",
      "¬´Barkatu¬ª pour s‚Äôexcuser / interpeller poliment.",
      "Exprimer l‚Äôincompr√©hension: ¬´Ez dut ulertzen¬ª.",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ S'il vous pla√Æt ¬ª en basque ?", options:["Mesedez","Eskerrik asko","Barkatu","Agur"], answer:"Mesedez", explain:"¬´Mesedez¬ª accompagne la demande."},
      {type:"mcq", prompt:"Traduction de ¬´ Ez dut ulertzen ¬ª", options:["Je ne comprends pas","Je comprends","Parlez plus fort","O√π sont les toilettes ?"], answer:"Je ne comprends pas", explain:"Forme standard batua."},
      {type:"bank", prompt:"Compose ¬´ Merci beaucoup ¬ª", acceptable:["eskerrik asko"], bank:["eskerrik","asko","mesedez","barkatu"], explain:"Litt. ¬´des mercis¬ª."},
      {type:"mcq", prompt:"¬´ Lagundu nazakezu? ¬ª", options:["Pouvez‚Äëvous m'aider ?","O√π allez‚Äëvous ?","Avez-vous faim ?","√Ä bient√¥t ?"], answer:"Pouvez‚Äëvous m'aider ?", explain:"Demander de l‚Äôaide poliment."}
    ]
  },
  {
    id:"l3",
    title:"Aurkezpena ¬∑ Se pr√©senter",
    tag:"Conversation",
    intro:"Se pr√©senter, demander o√π l‚Äôon habite, demander comment √ßa va.",
    vocab:[
      {eu:"Nire izena ‚Ä¶ da", fr:"Je m'appelle ‚Ä¶"},
      {eu:"Ni Manu naiz", fr:"Je suis Manu"},
      {eu:"Non bizi zara?", fr:"O√π habites‚Äëtu ?"},
      {eu:"Ni Donostian bizi naiz", fr:"J'habite √† Saint‚ÄëS√©bastien"},
      {eu:"Zer moduz?", fr:"Comment √ßa va ?"}
    ],
    grammar:[
      "Pr√©sentation: ¬´Nire izena X da¬ª.",
      "Identit√© (izan): ¬´ni ‚Ä¶ naiz / zu zara / hura da¬ª.",
      "Lieu de r√©sidence: ¬´bizi izan¬ª: ¬´Donostian bizi naiz¬ª.",
      "Demander l‚Äô√©tat: ¬´Zer moduz?¬ª",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ Je m'appelle Ainhoa ¬ª", options:["Nire izena Ainhoa da","Ainhoa naiz nire izena","Nire izena da Ainhoa","Ni Ainhoa zara"], answer:"Nire izena Ainhoa da", explain:"Structure: Nire izena X da."},
      {type:"mcq", prompt:"¬´ O√π habites‚Äëtu ? ¬ª", options:["Non bizi zara?","Nor zara?","Non zaude?","Non bizi naiz?"], answer:"Non bizi zara?", explain:"¬´Non ‚Ä¶?¬ª = O√π ?"},
      {type:"bank", prompt:"Compose ¬´ Je suis Manu ¬ª", acceptable:["ni manu naiz"], bank:["ni","Manu","naiz","nago","zara","da"], explain:"Avec ¬´izan¬ª (identit√©)."},
      {type:"bank", prompt:"Compose ¬´ J'habite √† Donostia ¬ª", acceptable:["ni donostian bizi naiz"], bank:["ni","Donostian","bizi","naiz","Zer","moduz"], explain:"Locatif ¬´-n¬ª: Donostia-n."}
    ]
  },
  {
    id:"l4",
    title:"Behar oinarrizkoak ¬∑ Besoins",
    tag:"Survie",
    intro:"Commander, demander des lieux, exprimer un besoin.",
    vocab:[
      {eu:"Ura nahi dut", fr:"Je veux de l'eau"},
      {eu:"Kafe bat, mesedez", fr:"Un caf√©, s'il vous pla√Æt"},
      {eu:"Non dago komuna?", fr:"O√π sont les toilettes ?"},
      {eu:"Zenbat da?", fr:"C'est combien ?"}
    ],
    grammar:[
      "Exprimer le d√©sir: ¬´nahi dut¬ª = je veux.",
      "Commander: ¬´X bat, mesedez¬ª.",
      "Demander un lieu: ¬´Non dago ‚Ä¶?¬ª",
      "Demander le prix: ¬´Zenbat da?¬ª",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"Traduction de ¬´ Non dago komuna? ¬ª", options:["O√π sont les toilettes ?","O√π est la gare ?","O√π est l'h√¥tel ?","O√π est la plage ?"], answer:"O√π sont les toilettes ?", explain:"¬´Komuna¬ª = toilettes."},
      {type:"bank", prompt:"Compose ¬´ Je veux de l‚Äôeau ¬ª", acceptable:["ura nahi dut"], bank:["ura","nahi","dut","kafe","bat","mesedez"], explain:"¬´ura¬ª (l‚Äôeau)."},
      {type:"mcq", prompt:"¬´ C'est combien ? ¬ª", options:["Zenbat da?","Zenbat gara?","Zenbat dugu?","Zenbat dena?"], answer:"Zenbat da?", explain:"Formule fixe."},
      {type:"bank", prompt:"Compose ¬´ Un caf√©, s‚Äôil vous pla√Æt ¬ª", acceptable:["kafe bat, mesedez","kafe bat mesedez"], bank:["kafe","bat,","mesedez","bat","egun","on"], explain:"¬´bat¬ª = un/une."}
    ]
  },
  {
    id:"l5",
    title:"Zenbakiak eta egunak ¬∑ Nombres & jours",
    tag:"Bases",
    intro:"Compter et nommer les jours en batua.",
    vocab:[
      {eu:"bat, bi, hiru, lau, bost", fr:"1, 2, 3, 4, 5"},
      {eu:"sei, zazpi, zortzi, bederatzi, hamar", fr:"6, 7, 8, 9, 10"},
      {eu:"astelehena / asteartea / asteazkena", fr:"lundi / mardi / mercredi"},
      {eu:"osteguna / ostirala", fr:"jeudi / vendredi"},
      {eu:"larunbata / igandea", fr:"samedi / dimanche"}
    ],
    grammar:[
      "Compter 1‚Äì10: bat, bi, hiru, lau, bost, sei, zazpi, zortzi, bederatzi, hamar.",
      "Jours: astel(e)hena, asteartea, asteazkena, osteguna, ostirala, larunbata, igandea.",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ 7 ¬ª en basque", options:["zazpi","zortzi","sei","bederatzi"], answer:"zazpi"},
      {type:"mcq", prompt:"¬´ osteguna ¬ª", options:["jeudi","vendredi","samedi","dimanche"], answer:"jeudi"},
      {type:"bank", prompt:"Compose ¬´ trois ¬ª", acceptable:["hiru"], bank:["bat","bi","hiru","lau","bost"], explain:"1 bat, 2 bi, 3 hiru."},
      {type:"mcq", prompt:"¬´ asteazkena ¬ª", options:["mercredi","mardi","jeudi","samedi"], answer:"mercredi"}
    ]
  },
  {
    id:"l6",
    title:"Familia ¬∑ Famille",
    tag:"Vie",
    intro:"La famille proche (terminologie batua).",
    vocab:[
      {eu:"ama", fr:"m√®re"},
      {eu:"aita", fr:"p√®re"},
      {eu:"semea / alaba", fr:"fils / fille"},
      {eu:"anai / arreba", fr:"fr√®re / s≈ìur (parlant = homme)"},
      {eu:"neba / ahizpa", fr:"fr√®re / s≈ìur (parlant = femme)"}
    ],
    grammar:[
      "Diff√©rences de ¬´fr√®re/s≈ìur¬ª selon le sexe du locuteur:",
      "Locuteur homme: anai/arreba; locutrice femme: neba/ahizpa.",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ ama ¬ª", options:["m√®re","p√®re","tante","grand‚Äëm√®re"], answer:"m√®re"},
      {type:"mcq", prompt:"¬´ alaba ¬ª", options:["fille","fils","soeur","m√®re"], answer:"fille"},
      {type:"bank", prompt:"Compose ¬´ p√®re ¬ª", acceptable:["aita"], bank:["aita","ama","anai","arreba"]},
      {type:"mcq", prompt:"Paire correcte (locuteur homme)", options:["anai/arreba","neba/ahizpa","neba/arreba","anai/ahizpa"], answer:"anai/arreba"}
    ]
  },
  {
    id:"l7",
    title:"Jatea eta edatea ¬∑ Manger/boire",
    tag:"Vie",
    intro:"Nourriture et boissons tr√®s courantes.",
    vocab:[
      {eu:"ogi", fr:"pain"},
      {eu:"gazta", fr:"fromage"},
      {eu:"arraina / haragia", fr:"poisson / viande"},
      {eu:"barazkiak / fruta", fr:"l√©gumes / fruits"},
      {eu:"ura / ardoa / garagardoa", fr:"eau / vin / bi√®re"}
    ],
    grammar:[
      "Lexique de base pour commander et parler des repas.",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ ogi ¬ª", options:["pain","lait","fromage","riz"], answer:"pain"},
      {type:"bank", prompt:"Compose ¬´ fromage ¬ª", acceptable:["gazta"], bank:["gazta","ogi","ardoa"]},
      {type:"mcq", prompt:"¬´ ardoa ¬ª", options:["vin","eau","bi√®re","jus"], answer:"vin"},
      {type:"bank", prompt:"Compose ¬´ eau ¬ª", acceptable:["ura"], bank:["ura","garagardoa","ogi"]}
    ]
  },
  {
    id:"l8",
    title:"Tokian toki ¬∑ Lieux & directions",
    tag:"Survie",
    intro:"Se rep√©rer en ville: gauche/droite, tout droit, pr√®s/loin.",
    vocab:[
      {eu:"Non dago ‚Ä¶?", fr:"O√π est ‚Ä¶ ?"},
      {eu:"ezker / eskuin", fr:"gauche / droite"},
      {eu:"zuzen", fr:"tout droit"},
      {eu:"gertu / urrun", fr:"pr√®s / loin"},
      {eu:"plaza / kalea / geltokia", fr:"place / rue / gare"}
    ],
    grammar:[
      "Indiquer la direction: ezker/eskuin/zuzen.",
      "Demander un lieu: ¬´Non dago ‚Ä¶ ?¬ª.",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ ezker ¬ª", options:["gauche","droite","loin","pr√®s"], answer:"gauche"},
      {type:"mcq", prompt:"¬´ zuzen ¬ª", options:["tout droit","√† gauche","lentement","plus tard"], answer:"tout droit"},
      {type:"bank", prompt:"Compose ¬´ O√π est la gare ? ¬ª", acceptable:["non dago geltokia?","non dago geltokia"], bank:["non","dago","geltokia","?","gertu","plaza"]},
      {type:"mcq", prompt:"¬´ gertu ¬ª", options:["pr√®s","loin","haut","bas"], answer:"pr√®s"}
    ]
  },
  {
    id:"l9",
    title:"Ordua eta egunerokoa ¬∑ Temps & routine",
    tag:"Vie",
    intro:"Moments de la journ√©e, aujourd‚Äôhui/demain/hier, routine.",
    vocab:[
      {eu:"Noiz?", fr:"Quand ?"},
      {eu:"Gaur / bihar / atzo", fr:"aujourd'hui / demain / hier"},
      {eu:"goizean / arratsaldean / gauean", fr:"le matin / l'apr√®s‚Äëmidi / le soir"},
      {eu:"Goizeko bederatzietan", fr:"√Ä neuf heures du matin"},
      {eu:"Astelehenetan lana dut", fr:"Le lundi, j'ai du travail"}
    ],
    grammar:[
      "Moments: goizean (matin), arratsaldean (apr√®s‚Äëmidi), gauean (soir).",
      "Heure: ¬´Goizeko bederatzietan¬ª (√† 9h du matin).",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ bihar ¬ª", options:["demain","hier","aujourd'hui","tout de suite"], answer:"demain"},
      {type:"mcq", prompt:"¬´ Noiz? ¬ª", options:["Quand ?","O√π ?","Qui ?","Combien ?"], answer:"Quand ?"},
      {type:"bank", prompt:"Compose ¬´ aujourd'hui ¬ª", acceptable:["gaur"], bank:["gaur","bihar","atzo"]},
      {type:"bank", prompt:"Compose ¬´ √Ä neuf heures du matin ¬ª", acceptable:["goizeko bederatzietan"], bank:["goizeko","bederatzietan","gauean","arratsaldean"]}
    ]
  },
  {
    id:"l10",
    title:"Aditzak oinarri ¬∑ Verbes de base",
    tag:"Grammaire",
    intro:"√ätre (izan/egon), avoir (eduki), aller (joan), venir (etorri).",
    vocab:[
      {eu:"izan (√™tre, ident.)", fr:"ni naiz / zu zara / hura da"},
      {eu:"egon (√™tre, lieu/√©tat)", fr:"ni nago / zu zaude / hura dago"},
      {eu:"eduki (avoir)", fr:"badut / baduzu / badu"},
      {eu:"joan (aller)", fr:"noa / zoaz / doa"},
      {eu:"etorri (venir)", fr:"nator / zatoz / dator"}
    ],
    grammar:[
      "izAN (identit√©) vs egON (√©tat/lieu): ¬´naiz¬ª vs ¬´nago¬ª.",
      "eduki: badut (j‚Äôai) / badu (il/elle a).",
      "joan (aller): noa; etorri (venir): nator.",
    ],
    baseQuestions:[
      {type:"mcq", prompt:"¬´ Je suis ¬ª (identit√©)", options:["ni naiz","ni nago","ni dut","ni noa"], answer:"ni naiz"},
      {type:"mcq", prompt:"¬´ Il est (se trouve) ¬ª ‚Üí egon", options:["hura dago","hura da","hura doa","hura dator"], answer:"hura dago"},
      {type:"bank", prompt:"Compose ¬´ Je vais ¬ª (joan)", acceptable:["noa"], bank:["noa","nator","naiz"]},
      {type:"bank", prompt:"Compose ¬´ Je viens ¬ª (etorri)", acceptable:["nator"], bank:["nator","noa","nago"]}
    ]
  }
];

/* ========== UTIL: normalize, shuffle ========== */
function norm(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim() }
function shuffle(arr){ return arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

/* ========== BUILD ~30 QUESTIONS PER LESSON ========== */
function expandLesson(base){
  const L = JSON.parse(JSON.stringify(base));
  let qs = L.baseQuestions.slice();

  // Auto-g√©n√©ration depuis le vocabulaire
  base.vocab.forEach(row => {
    // EU -> FR
    const correctFR = row.fr;
    const candFR = base.vocab.map(v=>v.fr).filter(v=>v!==correctFR);
    const distractFR = shuffle(candFR).slice(0, Math.min(3, candFR.length));
    const o1 = shuffle([correctFR, ...distractFR]);
    qs.push({type:"mcq", prompt:`Traduction de ¬´ ${row.eu} ¬ª`, options:o1, answer:correctFR, explain:`¬´${row.eu}¬ª ‚Üí ${correctFR}`});

    // FR -> EU
    const correctEU = row.eu;
    const parts = correctEU.split(" ");
    if (parts.length>1){
      const bank = Array.from(new Set(parts.concat(["kaixo","egun","on","mesedez","?","bat","eta"])));
      qs.push({type:"bank", prompt:`Compose ¬´ ${row.fr} ¬ª`, acceptable:[correctEU.toLowerCase()], bank: shuffle(bank), explain:`${row.fr} ‚Üí ¬´${correctEU}¬ª`});
    } else {
      const candEU = base.vocab.map(v=>v.eu).filter(v=>v!==correctEU);
      const distractEU = shuffle(candEU).slice(0, Math.min(3, candEU.length));
      const o2 = shuffle([correctEU, ...distractEU]);
      qs.push({type:"mcq", prompt:`Choisis ¬´ ${row.fr} ¬ª`, options:o2, answer:correctEU, explain:`${row.fr} ‚Üí ¬´${correctEU}¬ª`});
    }
  });

  // M√©langer et tronquer/√©tendre √† 30
  qs = shuffle(qs);
  const target = 30;
  while (qs.length < target){
    qs = qs.concat(shuffle(L.baseQuestions));
  }
  L.questions = qs.slice(0, target);
  return L;
}

/* ========== SPEECH & AUDIO ========== */
let audioCtx = null;
function beepOK(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type="sine"; o.frequency.value = 900;
  g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15);
  o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.16);
}
function beepNO(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type="square"; o.frequency.value = 220;
  g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);
  o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.26);
}
function speak(text){
  if(!("speechSynthesis" in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices();
  const v = voices.find(v=>/eu|basque/i.test(v.lang)) || voices.find(v=>/es-ES|es/i.test(v.lang));
  if (v) u.voice = v;
  u.rate = 0.95;
  speechSynthesis.speak(u);
}

/* ========== STATE ========== */
const App = {
  lessons: [],
  currentId: LESSONS_BASE[0].id,
  queue: [],
  current: null,
  answered: false,
  doneCount: 0,
  score: 0,
};

/* ========== STORAGE ========== */
function saveProgress(lessonId, score, total){
  localStorage.setItem("eu_progress_"+lessonId, JSON.stringify({score,total,ts:Date.now()}));
}
function loadProgress(lessonId){
  try{ return JSON.parse(localStorage.getItem("eu_progress_"+lessonId)) }catch(e){ return null }
}

/* ========== RENDER PICKER & INTRO ========== */
function $(s,r=document){ return r.querySelector(s) }
function renderLessons(){
  const list = $("#lesson-list"); list.innerHTML="";
  App.lessons.forEach((l, idx)=>{
    const saved = loadProgress(l.id);
    const div = document.createElement("div");
    div.className = "lesson-item";
    div.innerHTML = `
      <div class="meta"><span class="tag">${l.tag}</span><strong>${idx+1}. ${l.title}</strong></div>
      <div>${saved ? `<small>Score: ${saved.score}/${saved.total}</small>` : `<small class="muted">Nouveau</small>`}</div>`;
    div.addEventListener("click", ()=> selectLesson(l.id, false/*imm*/));
    list.appendChild(div);
  });
}
function renderVocabPreview(){
  const lesson = App.lessons.find(l=>l.id===App.currentId);
  const box = $("#vocab-preview"); box.innerHTML="";
  lesson.vocab.forEach(row=>{
    const div = document.createElement("div");
    div.className = "kv";
    div.innerHTML = `<div class="eu">${row.eu}</div><div class="fr">${row.fr}</div>`;
    box.appendChild(div);
  });
}

function selectLesson(id, immersive=false){
  App.currentId = id;
  const idx = App.lessons.findIndex(l=>l.id===id);
  $("#lesson-badge").textContent = "Le√ßon " + (idx+1);
  $("#lesson-title").textContent = App.lessons[idx].title;
  renderVocabPreview();
  // show intro page (before immersive quiz)
  showIntro(idx);
}

function showIntro(idx){
  const L = App.lessons[idx];
  $("#intro-title").textContent = L.title;
  $("#intro-text").textContent = LESSONS_BASE.find(b=>b.id===L.id).intro || "";
  const vocab = $("#intro-vocab"); vocab.innerHTML="";
  L.vocab.forEach(v=>{
    const d = document.createElement("div"); d.className="kv";
    d.innerHTML = `<div class="eu">${v.eu}</div><div class="fr">${v.fr}</div>`;
    vocab.appendChild(d);
  });
  const gram = $("#intro-grammar"); gram.innerHTML="";
  (LESSONS_BASE.find(b=>b.id===L.id).grammar||[]).forEach(g=>{
    const d = document.createElement("div"); d.className="kv";
    d.innerHTML = `<div class="eu">‚öë</div><div class="fr">${g}</div>`;
    gram.appendChild(d);
  });
  $("#intro").style.display="block";
}

/* ========== QUIZ LOGIC ========== */
function startImmersive(){
  document.body.classList.add("immersive");
  $("#intro").style.display="none";
  const L = App.lessons.find(l=>l.id===App.currentId);
  // build queue 30
  App.queue = shuffle(L.questions.slice());
  App.current = null;
  App.answered = false;
  App.doneCount = 0;
  App.score = 0;
  nextFromQueue();
  updateProgressBar();
}

function updateProgressBar(){
  const L = App.lessons.find(l=>l.id===App.currentId);
  const total = L.questions.length;
  const pct = Math.round((App.doneCount/total)*100);
  $("#progress").style.width = pct + "%";
  $("#counter").textContent = `${Math.min(App.doneCount+1,total)}/${total}`;
  $("#live-lesson").textContent = "Le√ßon " + (App.lessons.findIndex(x=>x.id===App.currentId)+1);
}

function nextFromQueue(){
  const L = App.lessons.find(l=>l.id===App.currentId);
  if (App.queue.length===0){
    finishLesson(L);
    return;
  }
  App.current = App.queue.shift();
  App.answered = false;
  renderQuestion(App.current);
  updateProgressBar();
}

function renderQuestion(q){
  $("#q-prompt").textContent = q.prompt;
  $("#q-options").innerHTML = "";
  $("#bank-wrap").classList.add("hide");
  $("#finish").classList.add("hide");
  $("#next").disabled = true;

  if (q.type === "mcq"){
    q.options.forEach(op=>{
      const b = document.createElement("button");
      b.className = "option";
      b.textContent = op;
      b.addEventListener("click", ()=>{
        if (App.answered) return;
        const ok = norm(op) === norm(q.answer);
        if (ok) b.classList.add("correct"); else b.classList.add("wrong");
        endQuestion(ok, q, op);
      });
      $("#q-options").appendChild(b);
    });
  } else if (q.type === "bank"){
    $("#bank-wrap").classList.remove("hide");
    setupWordBank(q);
  }

  $("#idk").onclick = ()=>{
    if (App.answered) return;
    endQuestion(false, q, null, /*idk*/true);
  };
  $("#next").onclick = ()=>{
    if (!App.answered) return;
    App.doneCount++;
    nextFromQueue();
  };
}

let bankState = {built:[]};
function setupWordBank(q){
  bankState.built = [];
  const strip = $("#answer-strip"); const wb = $("#wordbank");
  strip.innerHTML=""; wb.innerHTML="";
  const pool = shuffle([...(q.bank||[])]);
  pool.forEach(tok=>{
    const tile = document.createElement("button");
    tile.className = "tile";
    tile.textContent = tok;
    tile.addEventListener("click", ()=>{
      if (App.answered) return;
      bankState.built.push(tok);
      tile.classList.add("used");
      renderBankAnswer();
      checkBank(q);
    });
    wb.appendChild(tile);
  });
  $("#bank-undo").onclick = ()=>{
    if (App.answered) return;
    const last = bankState.built.pop();
    const tiles = Array.from($("#wordbank").children).reverse();
    const t = tiles.find(el => el.classList.contains("used") && el.textContent===last);
    if (t) t.classList.remove("used");
    renderBankAnswer();
  };
  $("#bank-clear").onclick = ()=>{
    if (App.answered) return;
    bankState.built = [];
    Array.from($("#wordbank").children).forEach(el=> el.classList.remove("used"));
    renderBankAnswer();
  };
  function renderBankAnswer(){
    strip.innerHTML="";
    bankState.built.forEach(t=>{
      const s = document.createElement("span");
      s.className="answer-token";
      s.textContent = t;
      strip.appendChild(s);
    });
  }
  function checkBank(q){
    const user = bankState.built.join(" ").replace(" ,", ",").replace(" ?", "?");
    const ok = (q.acceptable||[]).some(a => norm(a) === norm(user));
    if (ok){
      endQuestion(true, q, user);
    }
  }
}

/* ========== POPUP FEEDBACK + ERROR QUEUE ========== */
function showPopup(ok, msg, explain, wbw){
  const overlay = $("#overlay"); const modal = $("#modal");
  modal.className = "modal " + (ok? "ok":"no");
  $("#modal-title").textContent = ok ? "‚úÖ Zorionak!" : "‚ùå Erreur";
  $("#modal-msg").innerHTML = msg || "";
  $("#modal-explain").innerHTML = explain || "";
  $("#modal-wbw").innerHTML = wbw || "";
  overlay.style.display = "flex";
  $("#modal-continue").onclick = ()=>{
    overlay.style.display = "none";
    $("#next").disabled = false;
    if (ok){
      // auto-advance after a bit if desired:
      setTimeout(()=> { if (!overlay.style.display || overlay.style.display==='none'){ $("#next").click(); } }, 1200);
    }
  };
}

function endQuestion(ok, q, user, idk=false){
  App.answered = true;
  if (ok){ App.score++; beepOK(); } else { beepNO(); }

  // prepare explanations
  let expected = q.type==="bank" ? (q.acceptable ? q.acceptable[0] : "") : q.answer;
  let msg = "";
  if (ok){
    msg = `<strong>Bonne r√©ponse !</strong>`;
  } else if (idk){
    msg = `<strong>‚ÄúJe ne sais pas‚Äù</strong> ‚Üí on r√©vise maintenant.`;
  } else {
    msg = `<strong>Ta r√©ponse n'est pas correcte.</strong>`;
  }
  const extra = q.explain ? `<div style="margin-top:6px">${q.explain}</div>` : "";
  const wbw = buildWordByWord(expected);
  showPopup(ok, msg, extra, wbw);

  // if wrong ‚Üí push back to queue
  if (!ok){
    App.queue.push(q);
  }
}

/* mot-√†-mot simple: essaye de split par espaces et ponctuation */
function buildWordByWord(s){
  if (!s) return "";
  const parts = s.replace(/\?/g," ?").replace(/,/g," ,").split(/\s+/).filter(Boolean);
  const list = parts.map(p=>`<code>${p}</code>`).join(" ¬∑ ");
  return `<div><strong>Mot √† mot :</strong> ${list}</div>`;
}

/* ========== FINISH ========== */
function finishLesson(L){
  saveProgress(L.id, App.score, L.questions.length);
  // Confettis tr√®s simples (emoji)
  const overlay = $("#overlay"); const modal = $("#modal");
  modal.className = "modal ok";
  $("#modal-title").textContent = "üéâ Bravo !";
  $("#modal-msg").innerHTML = `Le√ßon termin√©e.<br><strong>Score: ${App.score}/${L.questions.length}</strong>`;
  $("#modal-explain").innerHTML = "";
  $("#modal-wbw").innerHTML = "";
  const idx = App.lessons.findIndex(x=>x.id===L.id);
  const hasNext = idx < App.lessons.length-1;
  const actions = modal.querySelector(".actions"); actions.innerHTML="";
  if (hasNext){
    const b1 = document.createElement("button");
    b1.className = "btn green"; b1.textContent = "Le√ßon suivante ‚ñ∂";
    b1.onclick = ()=>{
      $("#overlay").style.display="none";
      App.currentId = App.lessons[idx+1].id;
      startImmersive(); // encha√Æne
    };
    actions.appendChild(b1);
  }
  const b2 = document.createElement("button");
  b2.className = "btn"; b2.textContent = "Retour √† la liste";
  b2.onclick = ()=>{
    $("#overlay").style.display="none";
    document.body.classList.remove("immersive");
  };
  actions.appendChild(b2);
  overlay.style.display = "flex";
}

/* ========== INIT ========== */
window.addEventListener("DOMContentLoaded", ()=>{
  // Build expanded lessons
  App.lessons = LESSONS_BASE.map(expandLesson);
  renderLessons();
  // default preview
  selectLesson(App.lessons[0].id, false);

  $("#start").onclick = ()=>{ $("#intro-go").click(); };
  $("#intro-go").onclick = ()=> startImmersive();
  $("#tts-all").onclick = ()=>{
    const L = App.lessons.find(l=>l.id===App.currentId);
    const list = L.vocab.map(v=>v.eu);
    let i=0; (function step(){ if (i>=list.length) return; speak(list[i++]); setTimeout(step, 600); })();
  };

  // iOS audio unlock
  window.addEventListener('touchstart', ()=>{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }, {once:true});
  window.addEventListener('click', ()=>{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }, {once:true});
});
  </script>
</body>
</html>
